import{detect as ot}from"detect-browser";import{toMiliseconds as ee,FIVE_MINUTES as Ie,fromMiliseconds as st}from"@walletconnect/time";import{getDocument as ne,getNavigator as Pe,getLocation as je}from"@walletconnect/window-getters";import{getWindowMetadata as it}from"@walletconnect/window-metadata";import*as q from"query-string";import{hashMessage as Te}from"@ethersproject/hash";import{recoverAddress as ct}from"@ethersproject/transactions";import{ChaCha20Poly1305 as Ae}from"@stablelib/chacha20poly1305";import{HKDF as at}from"@stablelib/hkdf";import{randomBytes as B}from"@stablelib/random";import{SHA256 as Ce,hash as Ue}from"@stablelib/sha256";import*as _e from"@stablelib/x25519";import{toString as v,fromString as w,concat as te}from"uint8arrays";import{ec as ut}from"elliptic";import{decodeJWT as lt}from"@walletconnect/relay-auth";import{RELAY_JSONRPC as dt}from"@walletconnect/relay-api";const H=":";function re(e){const[n,t]=e.split(H);return{namespace:n,reference:t}}function ke(e){const{namespace:n,reference:t}=e;return[n,t].join(H)}function oe(e){const[n,t,r]=e.split(H);return{namespace:n,reference:t,address:r}}function De(e){const{namespace:n,reference:t,address:r}=e;return[n,t,r].join(H)}function se(e,n){const t=[];return e.forEach(r=>{const o=n(r);t.includes(o)||t.push(o)}),t}function xe(e){const{address:n}=oe(e);return n}function Ve(e){const{namespace:n,reference:t}=oe(e);return ke({namespace:n,reference:t})}function ft(e,n){const{namespace:t,reference:r}=re(n);return De({namespace:t,reference:r,address:e})}function pt(e){return se(e,xe)}function Me(e){return se(e,Ve)}function mt(e,n=[]){const t=[];return Object.keys(e).forEach(r=>{if(n.length&&!n.includes(r))return;const o=e[r];t.push(...o.accounts)}),t}function ht(e,n=[]){const t=[];return Object.keys(e).forEach(r=>{if(n.length&&!n.includes(r))return;const o=e[r];t.push(...Me(o.accounts))}),t}function yt(e,n=[]){const t=[];return Object.keys(e).forEach(r=>{if(n.length&&!n.includes(r))return;const o=e[r];t.push(...W(r,o))}),t}function W(e,n){return e.includes(":")?[e]:n.chains||[]}var gt=Object.defineProperty,Ke=Object.getOwnPropertySymbols,vt=Object.prototype.hasOwnProperty,bt=Object.prototype.propertyIsEnumerable,Le=(e,n,t)=>n in e?gt(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,Fe=(e,n)=>{for(var t in n||(n={}))vt.call(n,t)&&Le(e,t,n[t]);if(Ke)for(var t of Ke(n))bt.call(n,t)&&Le(e,t,n[t]);return e};const qe="ReactNative",y={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"},J=" ",Et=":",Be="/",ie=2,wt=1e3,He="js";function ce(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function $(){return!ne()&&!!Pe()&&navigator.product===qe}function Ot(){return $()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="android"}function Nt(){return $()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="ios"}function V(){return!ce()&&!!Pe()&&!!ne()}function A(){return $()?y.reactNative:ce()?y.node:V()?y.browser:y.unknown}function St(){var e;try{return $()&&typeof global<"u"&&typeof(global==null?void 0:global.Application)<"u"?(e=global.Application)==null?void 0:e.applicationId:void 0}catch{return}}function We(e,n){let t=q.parse(e);return t=Fe(Fe({},t),n),e=q.stringify(t),e}function $t(){return it()||{name:"",description:"",url:"",icons:[""]}}function Rt(e,n){var t;const r=A(),o={protocol:e,version:n,env:r};return r==="browser"&&(o.host=((t=je())==null?void 0:t.host)||"unknown"),o}function Je(){if(A()===y.reactNative&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"){const{OS:t,Version:r}=global.Platform;return[t,r].join("-")}const e=ot();if(e===null)return"unknown";const n=e.os?e.os.replace(" ","").toLowerCase():"unknown";return e.type==="browser"?[n,e.name,e.version].join("-"):[n,e.version].join("-")}function ze(){var e;const n=A();return n===y.browser?[n,((e=je())==null?void 0:e.host)||"unknown"].join(":"):n}function Ge(e,n,t){const r=Je(),o=ze();return[[e,n].join("-"),[He,t].join("-"),r,o].join("/")}function It({protocol:e,version:n,relayUrl:t,sdkVersion:r,auth:o,projectId:s,useOnCloseEvent:i,bundleId:u,packageName:l}){const c=t.split("?"),d=Ge(e,n,r),a={auth:o,ua:d,projectId:s,useOnCloseEvent:i||void 0,packageName:l||void 0,bundleId:u||void 0},f=We(c[1]||"",a);return c[0]+"?"+f}function Pt(e){let n=(e.match(/^[^:]+(?=:\/\/)/gi)||[])[0];const t=typeof n<"u"?e.split("://")[1]:e;return n=n==="wss"?"https":"http",[n,t].join("://")}function jt(e,n,t){if(!e[n]||typeof e[n]!==t)throw new Error(`Missing or invalid "${n}" param`)}function Ye(e,n=ie){return Qe(e.split(Be),n)}function Tt(e){return Ye(e).join(J)}function R(e,n){return e.filter(t=>n.includes(t)).length===e.length}function Qe(e,n=ie){return e.slice(Math.max(e.length-n,0))}function At(e){return Object.fromEntries(e.entries())}function Ct(e){return new Map(Object.entries(e))}function Ut(e,n){const t={};return Object.keys(e).forEach(r=>{t[r]=n(e[r])}),t}const _t=e=>e;function Ze(e){return e.trim().replace(/^\w/,n=>n.toUpperCase())}function kt(e){return e.split(J).map(n=>Ze(n)).join(J)}function Dt(e=Ie,n){const t=ee(e||Ie);let r,o,s,i;return{resolve:u=>{s&&r&&(clearTimeout(s),r(u),i=Promise.resolve(u))},reject:u=>{s&&o&&(clearTimeout(s),o(u))},done:()=>new Promise((u,l)=>{if(i)return u(i);s=setTimeout(()=>{const c=new Error(n);i=Promise.reject(c),l(c)},t),r=u,o=l})}}function xt(e,n,t){return new Promise(async(r,o)=>{const s=setTimeout(()=>o(new Error(t)),n);try{const i=await e;r(i)}catch(i){o(i)}clearTimeout(s)})}function ae(e,n){if(typeof n=="string"&&n.startsWith(`${e}:`))return n;if(e.toLowerCase()==="topic"){if(typeof n!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${n}`}else if(e.toLowerCase()==="id"){if(typeof n!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${n}`}throw new Error(`Unknown expirer target type: ${e}`)}function Vt(e){return ae("topic",e)}function Mt(e){return ae("id",e)}function Kt(e){const[n,t]=e.split(":"),r={id:void 0,topic:void 0};if(n==="topic"&&typeof t=="string")r.topic=t;else if(n==="id"&&Number.isInteger(Number(t)))r.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${n}:${t}`);return r}function Lt(e,n){return st((n||Date.now())+ee(e))}function Ft(e){return Date.now()>=ee(e)}function qt(e,n){return`${e}${n?`:${n}`:""}`}function N(e=[],n=[]){return[...new Set([...e,...n])]}async function Bt({id:e,topic:n,wcDeepLink:t}){var r;try{if(!t)return;const o=typeof t=="string"?JSON.parse(t):t,s=o?.href;if(typeof s!="string")return;const i=Xe(s,e,n),u=A();if(u===y.browser){if(!((r=ne())!=null&&r.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}i.startsWith("https://")||i.startsWith("http://")?window.open(i,"_blank","noreferrer noopener"):window.open(i,en()?"_blank":"_self","noreferrer noopener")}else u===y.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(i)}catch(o){console.error(o)}}function Xe(e,n,t){const r=`requestId=${n}&sessionTopic=${t}`;e.endsWith("/")&&(e=e.slice(0,-1));let o=`${e}`;if(e.startsWith("https://t.me")){const s=e.includes("?")?"&startapp=":"?startapp=";o=`${o}${s}${nn(r,!0)}`}else o=`${o}/wc?${r}`;return o}async function Ht(e,n){let t="";try{if(V()&&(t=localStorage.getItem(n),t))return t;t=await e.getItem(n)}catch(r){console.error(r)}return t}function ue(e,n){return e.filter(t=>n.includes(t))}function Wt(e,n){if(!e.includes(n))return null;const t=e.split(/([&,?,=])/),r=t.indexOf(n);return t[r+2]}function Jt(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,e=>{const n=Math.random()*16|0;return(e==="x"?n:n&3|8).toString(16)})}function zt(){return typeof process<"u"&&process.env.IS_VITEST==="true"}function en(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function nn(e,n=!1){const t=Buffer.from(e).toString("base64");return n?t.replace(/[=]/g,""):t}function le(e){return Buffer.from(e,"base64").toString("utf-8")}function Gt(e){return new Promise(n=>setTimeout(n,e))}const Yt="https://rpc.walletconnect.org/v1";async function tn(e,n,t,r,o,s){switch(t.t){case"eip191":return rn(e,n,t.s);case"eip1271":return await on(e,n,t.s,r,o,s);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}function rn(e,n,t){return ct(Te(n),t).toLowerCase()===e.toLowerCase()}async function on(e,n,t,r,o,s){const i=re(r);if(!i.namespace||!i.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${r}`);try{const u="0x1626ba7e",l="0000000000000000000000000000000000000000000000000000000000000040",c="0000000000000000000000000000000000000000000000000000000000000041",d=t.substring(2),a=Te(n).substring(2),f=u+a+l+c+d,h=await fetch(`${s||Yt}/?chainId=${r}&projectId=${o}`,{method:"POST",body:JSON.stringify({id:Qt(),jsonrpc:"2.0",method:"eth_call",params:[{to:e,data:f},"latest"]})}),{result:p}=await h.json();return p?p.slice(0,u.length).toLowerCase()===u.toLowerCase():!1}catch(u){return console.error("isValidEip1271Signature: ",u),!1}}function Qt(){return Date.now()+Math.floor(Math.random()*1e3)}var Zt=Object.defineProperty,Xt=Object.defineProperties,er=Object.getOwnPropertyDescriptors,sn=Object.getOwnPropertySymbols,nr=Object.prototype.hasOwnProperty,tr=Object.prototype.propertyIsEnumerable,cn=(e,n,t)=>n in e?Zt(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,de=(e,n)=>{for(var t in n||(n={}))nr.call(n,t)&&cn(e,t,n[t]);if(sn)for(var t of sn(n))tr.call(n,t)&&cn(e,t,n[t]);return e},an=(e,n)=>Xt(e,er(n));const rr="did:pkh:",z=e=>e?.split(":"),un=e=>{const n=e&&z(e);if(n)return e.includes(rr)?n[3]:n[1]},ln=e=>{const n=e&&z(e);if(n)return n[2]+":"+n[3]},fe=e=>{const n=e&&z(e);if(n)return n.pop()};async function or(e){const{cacao:n,projectId:t}=e,{s:r,p:o}=n,s=dn(o,o.iss),i=fe(o.iss);return await tn(i,s,r,ln(o.iss),t)}const dn=(e,n)=>{const t=`${e.domain} wants you to sign in with your Ethereum account:`,r=fe(n);if(!e.aud&&!e.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let o=e.statement||void 0;const s=`URI: ${e.aud||e.uri}`,i=`Version: ${e.version}`,u=`Chain ID: ${un(n)}`,l=`Nonce: ${e.nonce}`,c=`Issued At: ${e.iat}`,d=e.exp?`Expiration Time: ${e.exp}`:void 0,a=e.nbf?`Not Before: ${e.nbf}`:void 0,f=e.requestId?`Request ID: ${e.requestId}`:void 0,h=e.resources?`Resources:${e.resources.map(m=>`
- ${m}`).join("")}`:void 0,p=Y(e.resources);if(p){const m=I(p);o=he(o,m)}return[t,r,"",o,"",s,i,u,l,c,d,a,f,h].filter(m=>m!=null).join(`
`)};function sr(e,n,t){return t.includes("did:pkh:")||(t=`did:pkh:${t}`),{h:{t:"caip122"},p:{iss:t,domain:e.domain,aud:e.aud,version:e.version,nonce:e.nonce,iat:e.iat,statement:e.statement,requestId:e.requestId,resources:e.resources,nbf:e.nbf,exp:e.exp},s:n}}function ir(e){var n;const{authPayload:t,chains:r,methods:o}=e,s=t.statement||"";if(!(r!=null&&r.length))return t;const i=t.chains,u=ue(i,r);if(!(u!=null&&u.length))throw new Error("No supported chains");const l=fn(t.resources);if(!l)return t;O(l);const c=pn(l,"eip155");let d=t?.resources||[];if(c!=null&&c.length){const a=mn(c),f=ue(a,o);if(!(f!=null&&f.length))throw new Error(`Supported methods don't satisfy the requested: ${JSON.stringify(a)}, supported: ${JSON.stringify(o)}`);const h=pe("request",f,{chains:u}),p=vn(l,"eip155",h);d=((n=t?.resources)==null?void 0:n.slice(0,-1))||[],d.push(G(p))}return an(de({},t),{statement:En(s,Y(d)),chains:u,resources:t!=null&&t.resources||d.length>0?d:void 0})}function fn(e){const n=Y(e);if(n&&me(n))return I(n)}function cr(e,n){var t;return(t=e?.att)==null?void 0:t.hasOwnProperty(n)}function pn(e,n){var t,r;return(t=e?.att)!=null&&t[n]?Object.keys((r=e?.att)==null?void 0:r[n]):[]}function ar(e){return e?.map(n=>Object.keys(n))||[]}function mn(e){return e?.map(n=>{var t;return(t=n.split("/"))==null?void 0:t[1]})||[]}function hn(e){return Buffer.from(JSON.stringify(e)).toString("base64")}function yn(e){return JSON.parse(Buffer.from(e,"base64").toString("utf-8"))}function O(e){if(!e)throw new Error("No recap provided, value is undefined");if(!e.att)throw new Error("No `att` property found");const n=Object.keys(e.att);if(!(n!=null&&n.length))throw new Error("No resources found in `att` property");n.forEach(t=>{const r=e.att[t];if(Array.isArray(r))throw new Error(`Resource must be an object: ${t}`);if(typeof r!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(r).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(r).forEach(o=>{const s=r[o];if(!Array.isArray(s))throw new Error(`Ability limits ${o} must be an array of objects, found: ${s}`);if(!s.length)throw new Error(`Value of ${o} is empty array, must be an array with objects`);s.forEach(i=>{if(typeof i!="object")throw new Error(`Ability limits (${o}) must be an array of objects, found: ${i}`)})})})}function gn(e,n,t,r={}){return t?.sort((o,s)=>o.localeCompare(s)),{att:{[e]:pe(n,t,r)}}}function vn(e,n,t){var r;return e.att[n]=de({},t),((r=Object.keys(e.att))==null?void 0:r.sort((o,s)=>o.localeCompare(s))).reduce((o,s)=>(o.att[s]=e.att[s],o),{att:{}})}function pe(e,n,t={}){n=n?.sort((o,s)=>o.localeCompare(s));const r=n.map(o=>({[`${e}/${o}`]:[t]}));return Object.assign({},...r)}function G(e){return O(e),`urn:recap:${hn(e).replace(/=/g,"")}`}function I(e){const n=yn(e.replace("urn:recap:",""));return O(n),n}function ur(e,n,t){const r=gn(e,n,t);return G(r)}function me(e){return e&&e.includes("urn:recap:")}function lr(e,n){const t=I(e),r=I(n),o=bn(t,r);return G(o)}function bn(e,n){O(e),O(n);const t=Object.keys(e.att).concat(Object.keys(n.att)).sort((o,s)=>o.localeCompare(s)),r={att:{}};return t.forEach(o=>{var s,i;Object.keys(((s=e.att)==null?void 0:s[o])||{}).concat(Object.keys(((i=n.att)==null?void 0:i[o])||{})).sort((u,l)=>u.localeCompare(l)).forEach(u=>{var l,c;r.att[o]=an(de({},r.att[o]),{[u]:((l=e.att[o])==null?void 0:l[u])||((c=n.att[o])==null?void 0:c[u])})})}),r}function he(e="",n){O(n);const t="I further authorize the stated URI to perform the following actions on my behalf: ";if(e.includes(t))return e;const r=[];let o=0;Object.keys(n.att).forEach(u=>{const l=Object.keys(n.att[u]).map(a=>({ability:a.split("/")[0],action:a.split("/")[1]}));l.sort((a,f)=>a.action.localeCompare(f.action));const c={};l.forEach(a=>{c[a.ability]||(c[a.ability]=[]),c[a.ability].push(a.action)});const d=Object.keys(c).map(a=>(o++,`(${o}) '${a}': '${c[a].join("', '")}' for '${u}'.`));r.push(d.join(", ").replace(".,","."))});const s=r.join(" "),i=`${t}${s}`;return`${e?e+" ":""}${i}`}function dr(e){var n;const t=I(e);O(t);const r=(n=t.att)==null?void 0:n.eip155;return r?Object.keys(r).map(o=>o.split("/")[1]):[]}function fr(e){const n=I(e);O(n);const t=[];return Object.values(n.att).forEach(r=>{Object.values(r).forEach(o=>{var s;(s=o?.[0])!=null&&s.chains&&t.push(o[0].chains)})}),[...new Set(t.flat())]}function En(e,n){if(!n)return e;const t=I(n);return O(t),he(e,t)}function Y(e){if(!e)return;const n=e?.[e.length-1];return me(n)?n:void 0}const ye="base10",g="base16",ge="base64pad",pr="base64url",k="utf8",ve=0,D=1,M=2,mr=0,wn=1,K=12,be=32;function hr(){const e=_e.generateKeyPair();return{privateKey:v(e.secretKey,g),publicKey:v(e.publicKey,g)}}function yr(){const e=B(be);return v(e,g)}function gr(e,n){const t=_e.sharedKey(w(e,g),w(n,g),!0),r=new at(Ce,t).expand(be);return v(r,g)}function vr(e){const n=Ue(w(e,g));return v(n,g)}function br(e){const n=Ue(w(e,k));return v(n,g)}function Ee(e){return w(`${e}`,ye)}function C(e){return Number(v(e,ye))}function Er(e){const n=Ee(typeof e.type<"u"?e.type:ve);if(C(n)===D&&typeof e.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");const t=typeof e.senderPublicKey<"u"?w(e.senderPublicKey,g):void 0,r=typeof e.iv<"u"?w(e.iv,g):B(K),o=new Ae(w(e.symKey,g)).seal(r,w(e.message,k));return we({type:n,sealed:o,iv:r,senderPublicKey:t,encoding:e.encoding})}function wr(e,n){const t=Ee(M),r=B(K),o=w(e,k);return we({type:t,sealed:o,iv:r,encoding:n})}function Or(e){const n=new Ae(w(e.symKey,g)),{sealed:t,iv:r}=Q({encoded:e.encoded,encoding:e?.encoding}),o=n.open(r,t);if(o===null)throw new Error("Failed to decrypt");return v(o,k)}function Nr(e,n){const{sealed:t}=Q({encoded:e,encoding:n});return v(t,k)}function we(e){const{encoding:n=ge}=e;if(C(e.type)===M)return v(te([e.type,e.sealed]),n);if(C(e.type)===D){if(typeof e.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return v(te([e.type,e.senderPublicKey,e.iv,e.sealed]),n)}return v(te([e.type,e.iv,e.sealed]),n)}function Q(e){const{encoded:n,encoding:t=ge}=e,r=w(n,t),o=r.slice(mr,wn),s=wn;if(C(o)===D){const c=s+be,d=c+K,a=r.slice(s,c),f=r.slice(c,d),h=r.slice(d);return{type:o,sealed:h,iv:f,senderPublicKey:a}}if(C(o)===M){const c=r.slice(s),d=B(K);return{type:o,sealed:c,iv:d}}const i=s+K,u=r.slice(s,i),l=r.slice(i);return{type:o,sealed:l,iv:u}}function Sr(e,n){const t=Q({encoded:e,encoding:n?.encoding});return On({type:C(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?v(t.senderPublicKey,g):void 0,receiverPublicKey:n?.receiverPublicKey})}function On(e){const n=e?.type||ve;if(n===D){if(typeof e?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof e?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:n,senderPublicKey:e?.senderPublicKey,receiverPublicKey:e?.receiverPublicKey}}function $r(e){return e.type===D&&typeof e.senderPublicKey=="string"&&typeof e.receiverPublicKey=="string"}function Rr(e){return e.type===M}function Nn(e){return new ut("p256").keyFromPublic({x:Buffer.from(e.x,"base64").toString("hex"),y:Buffer.from(e.y,"base64").toString("hex")},"hex")}function Ir(e){let n=e.replace(/-/g,"+").replace(/_/g,"/");const t=n.length%4;return t>0&&(n+="=".repeat(4-t)),n}function Pr(e){return Buffer.from(Ir(e),"base64")}function jr(e,n){const[t,r,o]=e.split("."),s=Pr(o);if(s.length!==64)throw new Error("Invalid signature length");const i=s.slice(0,32).toString("hex"),u=s.slice(32,64).toString("hex"),l=`${t}.${r}`,c=new Ce().update(Buffer.from(l)).digest(),d=Nn(n),a=Buffer.from(c).toString("hex");if(!d.verify(a,{r:i,s:u}))throw new Error("Invalid signature");return lt(e).payload}const Sn="irn";function Tr(e){return e?.relay||{protocol:Sn}}function Ar(e){const n=dt[e];if(typeof n>"u")throw new Error(`Relay Protocol not supported: ${e}`);return n}var Cr=Object.defineProperty,Ur=Object.defineProperties,_r=Object.getOwnPropertyDescriptors,$n=Object.getOwnPropertySymbols,kr=Object.prototype.hasOwnProperty,Dr=Object.prototype.propertyIsEnumerable,Rn=(e,n,t)=>n in e?Cr(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,In=(e,n)=>{for(var t in n||(n={}))kr.call(n,t)&&Rn(e,t,n[t]);if($n)for(var t of $n(n))Dr.call(n,t)&&Rn(e,t,n[t]);return e},xr=(e,n)=>Ur(e,_r(n));function Pn(e,n="-"){const t={},r="relay"+n;return Object.keys(e).forEach(o=>{if(o.startsWith(r)){const s=o.replace(r,""),i=e[o];t[s]=i}}),t}function Vr(e){if(!e.includes("wc:")){const l=le(e);l!=null&&l.includes("wc:")&&(e=l)}e=e.includes("wc://")?e.replace("wc://",""):e,e=e.includes("wc:")?e.replace("wc:",""):e;const n=e.indexOf(":"),t=e.indexOf("?")!==-1?e.indexOf("?"):void 0,r=e.substring(0,n),o=e.substring(n+1,t).split("@"),s=typeof t<"u"?e.substring(t):"",i=q.parse(s),u=typeof i.methods=="string"?i.methods.split(","):void 0;return{protocol:r,topic:jn(o[0]),version:parseInt(o[1],10),symKey:i.symKey,relay:Pn(i),methods:u,expiryTimestamp:i.expiryTimestamp?parseInt(i.expiryTimestamp,10):void 0}}function jn(e){return e.startsWith("//")?e.substring(2):e}function Tn(e,n="-"){const t="relay",r={};return Object.keys(e).forEach(o=>{const s=t+n+o;e[o]&&(r[s]=e[o])}),r}function Mr(e){return`${e.protocol}:${e.topic}@${e.version}?`+q.stringify(In(xr(In({symKey:e.symKey},Tn(e.relay)),{expiryTimestamp:e.expiryTimestamp}),e.methods?{methods:e.methods.join(",")}:{}))}function Kr(e,n,t){return`${e}?wc_ev=${t}&topic=${n}`}var Lr=Object.defineProperty,Fr=Object.defineProperties,qr=Object.getOwnPropertyDescriptors,An=Object.getOwnPropertySymbols,Br=Object.prototype.hasOwnProperty,Hr=Object.prototype.propertyIsEnumerable,Cn=(e,n,t)=>n in e?Lr(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,Wr=(e,n)=>{for(var t in n||(n={}))Br.call(n,t)&&Cn(e,t,n[t]);if(An)for(var t of An(n))Hr.call(n,t)&&Cn(e,t,n[t]);return e},Jr=(e,n)=>Fr(e,qr(n));function U(e){const n=[];return e.forEach(t=>{const[r,o]=t.split(":");n.push(`${r}:${o}`)}),n}function Un(e){const n=[];return Object.values(e).forEach(t=>{n.push(...U(t.accounts))}),n}function _n(e,n){const t=[];return Object.values(e).forEach(r=>{U(r.accounts).includes(n)&&t.push(...r.methods)}),t}function kn(e,n){const t=[];return Object.values(e).forEach(r=>{U(r.accounts).includes(n)&&t.push(...r.events)}),t}function zr(e,n){const t=Wn(e,n);if(t)throw new Error(t.message);const r={};for(const[o,s]of Object.entries(e))r[o]={methods:s.methods,events:s.events,chains:s.accounts.map(i=>`${i.split(":")[0]}:${i.split(":")[1]}`)};return r}function Gr(e){const{proposal:{requiredNamespaces:n,optionalNamespaces:t={}},supportedNamespaces:r}=e,o=Ne(n),s=Ne(t),i={};Object.keys(r).forEach(c=>{const d=r[c].chains,a=r[c].methods,f=r[c].events,h=r[c].accounts;d.forEach(p=>{if(!h.some(m=>m.includes(p)))throw new Error(`No accounts provided for chain ${p} in namespace ${c}`)}),i[c]={chains:d,methods:a,events:f,accounts:h}});const u=zn(n,i,"approve()");if(u)throw new Error(u.message);const l={};return!Object.keys(n).length&&!Object.keys(t).length?i:(Object.keys(o).forEach(c=>{const d=r[c].chains.filter(p=>{var m,E;return(E=(m=o[c])==null?void 0:m.chains)==null?void 0:E.includes(p)}),a=r[c].methods.filter(p=>{var m,E;return(E=(m=o[c])==null?void 0:m.methods)==null?void 0:E.includes(p)}),f=r[c].events.filter(p=>{var m,E;return(E=(m=o[c])==null?void 0:m.events)==null?void 0:E.includes(p)}),h=d.map(p=>r[c].accounts.filter(m=>m.includes(`${p}:`))).flat();l[c]={chains:d,methods:a,events:f,accounts:h}}),Object.keys(s).forEach(c=>{var d,a,f,h,p,m;if(!r[c])return;const E=(a=(d=s[c])==null?void 0:d.chains)==null?void 0:a.filter(j=>r[c].chains.includes(j)),nt=r[c].methods.filter(j=>{var T,x;return(x=(T=s[c])==null?void 0:T.methods)==null?void 0:x.includes(j)}),tt=r[c].events.filter(j=>{var T,x;return(x=(T=s[c])==null?void 0:T.events)==null?void 0:x.includes(j)}),rt=E?.map(j=>r[c].accounts.filter(T=>T.includes(`${j}:`))).flat();l[c]={chains:N((f=l[c])==null?void 0:f.chains,E),methods:N((h=l[c])==null?void 0:h.methods,nt),events:N((p=l[c])==null?void 0:p.events,tt),accounts:N((m=l[c])==null?void 0:m.accounts,rt)}}),l)}function Oe(e){return e.includes(":")}function Dn(e){return Oe(e)?e.split(":")[0]:e}function Ne(e){var n,t,r;const o={};if(!Z(e))return o;for(const[s,i]of Object.entries(e)){const u=Oe(s)?[s]:i.chains,l=i.methods||[],c=i.events||[],d=Dn(s);o[d]=Jr(Wr({},o[d]),{chains:N(u,(n=o[d])==null?void 0:n.chains),methods:N(l,(t=o[d])==null?void 0:t.methods),events:N(c,(r=o[d])==null?void 0:r.events)})}return o}function xn(e){const n={};return e?.forEach(t=>{const[r,o]=t.split(":");n[r]||(n[r]={accounts:[],chains:[],events:[]}),n[r].accounts.push(t),n[r].chains.push(`${r}:${o}`)}),n}function Yr(e,n){n=n.map(r=>r.replace("did:pkh:",""));const t=xn(n);for(const[r,o]of Object.entries(t))o.methods?o.methods=N(o.methods,e):o.methods=e,o.events=["chainChanged","accountsChanged"];return t}const Vn={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Mn={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function S(e,n){const{message:t,code:r}=Mn[e];return{message:n?`${t} ${n}`:t,code:r}}function _(e,n){const{message:t,code:r}=Vn[e];return{message:n?`${t} ${n}`:t,code:r}}function L(e,n){return Array.isArray(e)?typeof n<"u"&&e.length?e.every(n):!0:!1}function Z(e){return Object.getPrototypeOf(e)===Object.prototype&&Object.keys(e).length}function P(e){return typeof e>"u"}function b(e,n){return n&&P(e)?!0:typeof e=="string"&&!!e.trim().length}function X(e,n){return n&&P(e)?!0:typeof e=="number"&&!isNaN(e)}function Qr(e,n){const{requiredNamespaces:t}=n,r=Object.keys(e.namespaces),o=Object.keys(t);let s=!0;return R(o,r)?(r.forEach(i=>{const{accounts:u,methods:l,events:c}=e.namespaces[i],d=U(u),a=t[i];(!R(W(i,a),d)||!R(a.methods,l)||!R(a.events,c))&&(s=!1)}),s):!1}function F(e){return b(e,!1)&&e.includes(":")?e.split(":").length===2:!1}function Kn(e){if(b(e,!1)&&e.includes(":")){const n=e.split(":");if(n.length===3){const t=n[0]+":"+n[1];return!!n[2]&&F(t)}}return!1}function Zr(e){function n(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(b(e,!1)){if(n(e))return!0;const t=le(e);return n(t)}}catch{}return!1}function Xr(e){var n;return(n=e?.proposer)==null?void 0:n.publicKey}function eo(e){return e?.topic}function no(e,n){let t=null;return b(e?.publicKey,!1)||(t=S("MISSING_OR_INVALID",`${n} controller public key should be a string`)),t}function Se(e){let n=!0;return L(e)?e.length&&(n=e.every(t=>b(t,!1))):n=!1,n}function Ln(e,n,t){let r=null;return L(n)&&n.length?n.forEach(o=>{r||F(o)||(r=_("UNSUPPORTED_CHAINS",`${t}, chain ${o} should be a string and conform to "namespace:chainId" format`))}):F(e)||(r=_("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),r}function Fn(e,n,t){let r=null;return Object.entries(e).forEach(([o,s])=>{if(r)return;const i=Ln(o,W(o,s),`${n} ${t}`);i&&(r=i)}),r}function qn(e,n){let t=null;return L(e)?e.forEach(r=>{t||Kn(r)||(t=_("UNSUPPORTED_ACCOUNTS",`${n}, account ${r} should be a string and conform to "namespace:chainId:address" format`))}):t=_("UNSUPPORTED_ACCOUNTS",`${n}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function Bn(e,n){let t=null;return Object.values(e).forEach(r=>{if(t)return;const o=qn(r?.accounts,`${n} namespace`);o&&(t=o)}),t}function Hn(e,n){let t=null;return Se(e?.methods)?Se(e?.events)||(t=_("UNSUPPORTED_EVENTS",`${n}, events should be an array of strings or empty array for no events`)):t=_("UNSUPPORTED_METHODS",`${n}, methods should be an array of strings or empty array for no methods`),t}function $e(e,n){let t=null;return Object.values(e).forEach(r=>{if(t)return;const o=Hn(r,`${n}, namespace`);o&&(t=o)}),t}function to(e,n,t){let r=null;if(e&&Z(e)){const o=$e(e,n);o&&(r=o);const s=Fn(e,n,t);s&&(r=s)}else r=S("MISSING_OR_INVALID",`${n}, ${t} should be an object with data`);return r}function Wn(e,n){let t=null;if(e&&Z(e)){const r=$e(e,n);r&&(t=r);const o=Bn(e,n);o&&(t=o)}else t=S("MISSING_OR_INVALID",`${n}, namespaces should be an object with data`);return t}function Jn(e){return b(e.protocol,!0)}function ro(e,n){let t=!1;return n&&!e?t=!0:e&&L(e)&&e.length&&e.forEach(r=>{t=Jn(r)}),t}function oo(e){return typeof e=="number"}function so(e){return typeof e<"u"&&typeof e!==null}function io(e){return!(!e||typeof e!="object"||!e.code||!X(e.code,!1)||!e.message||!b(e.message,!1))}function co(e){return!(P(e)||!b(e.method,!1))}function ao(e){return!(P(e)||P(e.result)&&P(e.error)||!X(e.id,!1)||!b(e.jsonrpc,!1))}function uo(e){return!(P(e)||!b(e.name,!1))}function lo(e,n){return!(!F(n)||!Un(e).includes(n))}function fo(e,n,t){return b(t,!1)?_n(e,n).includes(t):!1}function po(e,n,t){return b(t,!1)?kn(e,n).includes(t):!1}function zn(e,n,t){let r=null;const o=mo(e),s=ho(n),i=Object.keys(o),u=Object.keys(s),l=Gn(Object.keys(e)),c=Gn(Object.keys(n)),d=l.filter(a=>!c.includes(a));return d.length&&(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${d.toString()}
      Received: ${Object.keys(n).toString()}`)),R(i,u)||(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${i.toString()}
      Approved: ${u.toString()}`)),Object.keys(n).forEach(a=>{if(!a.includes(":")||r)return;const f=U(n[a].accounts);f.includes(a)||(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${a}
        Required: ${a}
        Approved: ${f.toString()}`))}),i.forEach(a=>{r||(R(o[a].methods,s[a].methods)?R(o[a].events,s[a].events)||(r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${a}`)):r=S("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${a}`))}),r}function mo(e){const n={};return Object.keys(e).forEach(t=>{var r;t.includes(":")?n[t]=e[t]:(r=e[t].chains)==null||r.forEach(o=>{n[o]={methods:e[t].methods,events:e[t].events}})}),n}function Gn(e){return[...new Set(e.map(n=>n.includes(":")?n.split(":")[0]:n))]}function ho(e){const n={};return Object.keys(e).forEach(t=>{if(t.includes(":"))n[t]=e[t];else{const r=U(e[t].accounts);r?.forEach(o=>{n[o]={accounts:e[t].accounts.filter(s=>s.includes(`${o}:`)),methods:e[t].methods,events:e[t].events}})}}),n}function yo(e,n){return X(e,!1)&&e<=n.max&&e>=n.min}function go(){const e=A();return new Promise(n=>{switch(e){case y.browser:n(Yn());break;case y.reactNative:n(Qn());break;case y.node:n(Zn());break;default:n(!0)}})}function Yn(){return V()&&navigator?.onLine}async function Qn(){if($()&&typeof global<"u"&&global!=null&&global.NetInfo){const e=await(global==null?void 0:global.NetInfo.fetch());return e?.isConnected}return!0}function Zn(){return!0}function vo(e){switch(A()){case y.browser:Xn(e);break;case y.reactNative:et(e);break;case y.node:break}}function Xn(e){!$()&&V()&&(window.addEventListener("online",()=>e(!0)),window.addEventListener("offline",()=>e(!1)))}function et(e){$()&&typeof global<"u"&&global!=null&&global.NetInfo&&global?.NetInfo.addEventListener(n=>e(n?.isConnected))}const Re={};class bo{static get(n){return Re[n]}static set(n,t){Re[n]=t}static delete(n){delete Re[n]}}export{ye as BASE10,g as BASE16,ge as BASE64,pr as BASE64URL,Et as COLON,ie as DEFAULT_DEPTH,J as EMPTY_SPACE,y as ENV_MAP,Mn as INTERNAL_ERRORS,bo as MemoryStore,wt as ONE_THOUSAND,qe as REACT_NATIVE_PRODUCT,Sn as RELAYER_DEFAULT_PROTOCOL,Vn as SDK_ERRORS,He as SDK_TYPE,Be as SLASH,ve as TYPE_0,D as TYPE_1,M as TYPE_2,k as UTF8,vn as addResourceToRecap,We as appendToQueryString,jt as assertType,pe as assignAbilityToActions,yn as base64Decode,hn as base64Encode,Gr as buildApprovedNamespaces,sr as buildAuthObject,Yr as buildNamespacesFromAuth,En as buildRecapStatement,Lt as calcExpiry,kt as capitalize,Ze as capitalizeWord,Dt as createDelayedPromise,ur as createEncodedRecap,xt as createExpiringPromise,gn as createRecap,I as decodeRecap,C as decodeTypeByte,Nr as decodeTypeTwoEnvelope,Or as decrypt,gr as deriveSymKey,Q as deserialize,G as encodeRecap,Ee as encodeTypeByte,wr as encodeTypeTwoEnvelope,Er as encrypt,qt as engineEvent,_t as enumify,De as formatAccountId,ft as formatAccountWithChain,ke as formatChainId,Xe as formatDeeplinkUrl,ae as formatExpirerTarget,Mt as formatIdTarget,dn as formatMessage,Tt as formatMessageContext,Tn as formatRelayParams,It as formatRelayRpcUrl,he as formatStatementFromRecap,Vt as formatTopicTarget,Ge as formatUA,Mr as formatUri,le as fromBase64,hr as generateKeyPair,yr as generateRandomBytes32,U as getAccountsChains,mt as getAccountsFromNamespaces,xe as getAddressFromAccount,pt as getAddressesFromAccounts,St as getAppId,$t as getAppMetadata,Yn as getBrowserOnlineStatus,Ve as getChainFromAccount,Me as getChainsFromAccounts,W as getChainsFromNamespace,ht as getChainsFromNamespaces,fr as getChainsFromRecap,yt as getChainsFromRequiredNamespaces,ue as getCommonValuesInArrays,Nn as getCryptoKeyFromKeyData,fn as getDecodedRecapFromResources,Ht as getDeepLink,fe as getDidAddress,z as getDidAddressSegments,un as getDidChainId,A as getEnvironment,Pt as getHttpUrl,S as getInternalError,ze as getJavascriptID,Je as getJavascriptOS,Qe as getLastItems,Kr as getLinkModeURL,dr as getMethodsFromRecap,ln as getNamespacedDidChainId,Un as getNamespacesChains,kn as getNamespacesEventsForChainId,xn as getNamespacesFromAccounts,_n as getNamespacesMethodsForChainId,Zn as getNodeOnlineStatus,mn as getReCapActions,Qn as getReactNativeOnlineStatus,ar as getRecapAbilitiesFromResource,Y as getRecapFromResources,pn as getRecapResource,Rt as getRelayClientMetadata,Ar as getRelayProtocolApi,Tr as getRelayProtocolName,zr as getRequiredNamespacesFromNamespaces,_ as getSdkError,Wt as getSearchParamFromURL,se as getUniqueValues,Bt as handleDeeplinkRedirect,R as hasOverlap,vr as hashKey,br as hashMessage,Ot as isAndroid,V as isBrowser,Oe as isCaipNamespace,zn as isConformingNamespaces,Ft as isExpired,Nt as isIos,ce as isNode,go as isOnline,Xr as isProposalStruct,$ as isReactNative,me as isRecap,Qr as isSessionCompatible,eo as isSessionStruct,en as isTelegram,zt as isTestRun,$r as isTypeOneEnvelope,Rr as isTypeTwoEnvelope,P as isUndefined,Kn as isValidAccountId,qn as isValidAccounts,Hn as isValidActions,L as isValidArray,F as isValidChainId,Ln as isValidChains,no as isValidController,on as isValidEip1271Signature,rn as isValidEip191Signature,io as isValidErrorReason,uo as isValidEvent,oo as isValidId,Bn as isValidNamespaceAccounts,$e as isValidNamespaceActions,Fn as isValidNamespaceChains,Se as isValidNamespaceMethodsOrEvents,Wn as isValidNamespaces,lo as isValidNamespacesChainId,po as isValidNamespacesEvent,fo as isValidNamespacesRequest,X as isValidNumber,Z as isValidObject,so as isValidParams,O as isValidRecap,Jn as isValidRelay,ro as isValidRelays,co as isValidRequest,yo as isValidRequestExpiry,to as isValidRequiredNamespaces,ao as isValidResponse,b as isValidString,Zr as isValidUrl,Ut as mapEntries,At as mapToObj,N as mergeArrays,lr as mergeEncodedRecaps,bn as mergeRecaps,Ne as normalizeNamespaces,Ct as objToMap,oe as parseAccountId,re as parseChainId,Ye as parseContextNames,Kt as parseExpirerTarget,Dn as parseNamespaceKey,Pn as parseRelayParams,jn as parseTopic,Vr as parseUri,ir as populateAuthPayload,cr as recapHasResource,we as serialize,Gt as sleep,Xn as subscribeToBrowserNetworkChange,vo as subscribeToNetworkChange,et as subscribeToReactNativeNetworkChange,nn as toBase64,Jt as uuidv4,Sr as validateDecoding,On as validateEncoding,or as validateSignedCacao,jr as verifyP256Jwt,tn as verifySignature};
//# sourceMappingURL=index.es.js.map
